var getComments=function(){var n=$(this).attr("data-page");$.ajax({url:"/Comments/GetComments",type:"GET",data:{page:n},success:function(n){$("#CommentListSegment").html(n)},error:function(){alert("Something happened!")}})};$(document).ready(function(){$("#SubmitComment").click(function(){var n=$("#CommentText").val();$.ajax({url:"/Comments/CreateFromPartial",data:{data:n},type:"POST",success:function(){$("#CommentText").val("");getComments()},error:function(){alert("Something happened")}})})});$("#CommentListSegment").on("click",".SwitchPageBtn",getComments);(function(){var w,b,k,d,a,tt,h,v,o,c,r,i,s,y,g,nt,p,f,l,n=window.$game={_mode:null,busy:!1},u,t,e;n.new=function(){this.mode("map")};n.reset=function(){this.mode("welcome")};n.save=function(){return{mode:this._mode,map:this.map.save(),dialog:this.dialog.save(),quest:this.quest.save()}};n.load=function(n){n&&(this.mode(n.mode),this.map.load(n.map),this.dialog.load(n.dialog),this.quest.load(n.quest),this.mode(n.mode))};n.serverSave=function(n){var t=n?"":JSON.stringify(this.save());$("#game-save-data").text(t);$.ajax({method:"post",url:"/Manage/UpdateSaveData",data:{data:t}})};n.serverLoad=function(){var n=$("#game-save-data").text();n.length>0&&(console.log("load now"),this.load(JSON.parse(n)))};n.mode=function(n,t){if(!this.busy){switch(n){case"dialog":this.map.show(!1);this.quest.begin(null);this._showWelcome(!1);t!==undefined?this.dialog.goto(null,t):this.dialog.show(!0);break;case"map":this.dialog.show(!1);this.quest.begin(null);this._showWelcome(!1);this.map.show(!0);break;case"welcome":this.map.show(!1);this.dialog.show(!1);this.quest.begin(null);this._showWelcome(!0);break;case"quest":this.map.show(!1);this.dialog.show(!1);this._showWelcome(!1);t!==undefined?this.quest.begin(t):this.quest.show(!0);break;default:console.error("Invalid mode '"+n+"'")}this._mode=n}};n._showWelcome=function(n){k.css("display",n?"":"none")};u=n.map={_areas:{},_blocked:{}};u.save=function(){return{blocked:$.extend({},this._blocked)}};u.load=function(n){this._blocked=$.extend({},n.blocked);for(var t in this._areas)this._areas.hasOwnProperty(t)&&this.setBlocked(t,this._blocked[t])};u.addArea=function(n,t,i,r){var u=this._areas[n]={name:n,pos:t.slice(),title:i,menu:r.slice()};this._blocked[n]=!0};u.show=function(t){var f,u,i,r;if(!n.busy){if(t&&!this._init){this._init=!0;f=$("#map-area-tpl").html();for(u in this._areas)this._areas.hasOwnProperty(u)&&(i=this._areas[u],r=i.elem=$(f),r.appendTo(a),this._blocked[i.name]&&r.addClass("blocked"),r.css("left",i.pos[0]+"%"),r.css("top",i.pos[1]+"%"),r.css("width",i.pos[2]+"%"),r.css("height",i.pos[3]+"%"),r.click(this._showChapterMenu.bind(this,i)))}a.css("display",t?"":"none")}};u.setBlocked=function(n,t){var i=this._areas[n];if(!i){console.error("Invalid map area '"+n+"'");return}this._blocked[n]=!!t;i.elem&&i.elem.toggleClass("blocked",t)};u._showChapterMenu=function(n){var f,e,i,t,r,u,o;if(!this._blocked[n.name]){for(f=$("#map-chapter-menu-tpl").html(),v.html(null),e=$(".ch-title",h),e.html(n.title),i=0;i<n.menu.length;i++)t=n.menu[i],r=$(f),r.appendTo(v),u=$(".cc-img",r),o=$(".cc-text",r),o.html(t.name),t.icon&&u.attr("src",t.icon),u.click(this._selectChapter.bind(this,t));h.modal("show")}};u._selectChapter=function(t){h.modal("hide");t.dialog&&n.mode("dialog",t.dialog)};t=n.dialog={_stages:{},_actions:{},_index:0,_stage:null};t.save=function(){return{index:this._index,stage:this._stage?this._stage.name:null,image:i.attr("src"),scene:$U.getBgImage(s),text:c.html(),name:r.html()}};t.load=function(n){this._index=n.index;this._stage=this._stages[n.stage];n.image?(i.attr("src",n.image),i.removeClass("dg-hidden")):i.addClass("dg-hidden");$U.setBgImage(s,n.scene);c.html(n.text);n.name?(r.html(n.name),r.css("display","")):r.css("display","none")};t.setStage=function(n,t){for(var r={},i=0;i<t.length;i++)t[i].id&&(r[t[i].id]=i);this._stages[n]={name:n,data:t.slice(),labels:r}};t.setAction=function(n,t){this._actions[n]=t};t.advance=function(){var t,e,f,u,h;if(this._stage&&!n.busy){n:while(t=this._stage.data[this._index]){this._index++;switch(t.do){case"say":c.html(t.text);t.name?(r.css("display",""),r.html(t.name)):r.css("display","none");break n;case"image":if(e=i.attr("src"),f=t.url||o,t.now&&e!=o&&f!=o){i.attr("src",f);break}else{u=$U.always({self:this,url:f});e!=o&&(u=u.then(function(n){return i.addClass("dg-hidden"),$U.delay(500,n)}));f!=o&&(u=u.then(function(n){return i.attr("src",n.url),i.removeClass("dg-hidden"),$U.delay(500,n)}));u.then(function(t){n.busy=!1;t.self.advance()});n.busy=!0;break n}case"scene":u=$U.always({url:t.url,text:t.text,self:this});u=u.then(function(n){return g.html(n.text||null),y.addClass("dg-faded"),$U.delay(500,n)});t.text&&(u=u.then(function(n){return $U.delay(1e3,n)}));u.then(function(n){return y.removeClass("dg-faded"),$U.setBgImage(s,n.url),$U.delay(500,n)}).then(function(t){n.busy=!1;t.self.advance()});n.busy=!0;break n;case"goto":this._goto(t.label,t.stage);break;case"action":if(h=this._actions[t.name]){if(h.apply(n,t.args))break n}else t.name&&console.error("Invalid action '"+t.name+"'")}}p.css("display",t?"":"none")}};t._goto=function(n,t){var i,r;if(t){if(i=this._stages[t],!i){console.error("Invalid stage '"+t+"'");return}this._stage=i}if(n){if(r=this._stage.labels[n],!r){console.error("Invalid label '"+n+"'");return}this._index=r}else this._index=0};t.goto=function(t,i){n.busy||(this._goto(t,i),this.advance())};t.show=function(t){this._stage&&!n.busy&&(nt.css("display",t?"":"none"),s.css("display",t?"":"none"))};t.setAction("show",function(){this.dialog.show(!0)});t.setAction("hide",function(){this.dialog.show(!1)});t.setAction("ChapterDone",function(n,t){t&&this.map.setBlocked(t,!1);this.mode("map")});t.setAction("StartQuest",function(n){return this.mode("quest",n),!0});e=n.quest={_isload:!1,_url:null};e.save=function(){return{url:this._url}};e.load=function(n){this.begin(n.url)};e.begin=function(t){n.busy||(t?(n.busy=!0,this._isload=!0,this._url=t,f.attr("src",t),l.css("display","")):(this._url=null,f.attr("src","about:blank"),f.css("display","none"),l.css("display","none")))};e.show=function(t){this._url&&!n.busy&&f.css("display",t?"":"none")};e._onLoad=function(){this._isload&&(n.busy=!1,this._isload=!1,f.css("display",""),l.css("display","none"))};e._onMessage=function(t){switch(t){case"quest-ok":n.mode("dialog");n.dialog.advance()}};$(document).ready(function(){w=$("a.newgame-btn");b=$("a.savegame-btn");k=$(".game-welcome");d=$(".game-welcome .play-btn");c=$(".dg-text span.text");r=$(".dg-text span.name");i=$(".dg-image img");s=$(".dialog-scene");y=$(".dialog-fade");g=$(".dialog-fade .fade-text");nt=$(".dialog-box");p=$(".dialog-box a.next-btn");o=i.attr("src");i.addClass("dg-hidden");a=$(".map-body");tt=$(".map-body img.map-bg");h=$("#map-chapter-menu");v=$("#map-chapter-menu .ch-list");f=$("iframe.quest-embed");l=$(".quest-loading");p.click(function(){n.dialog.advance()});f.on("load",function(){n.quest._onLoad()});$(window).on("message",function(t){var i=t.originalEvent.data;n.quest._onMessage(i)});d.click(function(){var t=$("#game-save-data").text();t.length>0&&confirm("Загрузить ранее сохранённый прогресс?")?n.serverLoad():(n.new(),n.serverSave(!0))});w.click(function(){confirm("Действительно начать игру заново?")&&(n.reset(),n.serverSave(!0))});b.click(function(){n.serverSave(!1);alert("Ваш игровой прогресс сохранён!")})})}).call(this),function(){var n=window.$U={};n.getBgImage=function(n){var i=$(n).css("background-image"),t=i.match(/url\("(.+)"\)/i);return t&&t[1]?t[1]:null};n.setBgImage=function(n,t){t?(t='url("'+t.replace('"',"%22")+'")',$(n).css("background-image",t)):$(n).css("background-image","none")};n.delay=function(n,t){return $.Deferred(function(i){setTimeout(i.resolve.bind(null,t),n)})};n.always=function(n){return $.Deferred(function(t){t.resolve.call(null,n)})}}.call(this);$(document).ready(function(){$("div.has-bg img.is-bg").each(function(){var n=$(this);$U.setBgImage(n.parent(),n.attr("src"));n.remove()});$(".system-menu > a").each(function(){$(this).attr("href","javascript:void(0)")});var n=$("a.fullscreen-btn");n.click(function(){if(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen();else{var t=$(this).attr("data-target"),n=document.getElementById(t);n.requestFullscreen?n.requestFullscreen():n.mozRequestFullScreen?n.mozRequestFullScreen():n.webkitRequestFullscreen?n.webkitRequestFullscreen():n.msRequestFullscreen&&n.msRequestFullscreen()}})});