var getComments=function(){var n=$(this).attr("data-page");$.ajax({url:"/Comments/GetComments",type:"GET",data:{page:n},success:function(n){$("#CommentListSegment").html(n)},error:function(){alert("Something happened!")}})};$(document).ready(function(){$("#SubmitComment").click(function(){var n=$("#CommentText").val();$.ajax({url:"/Comments/CreateFromPartial",data:{data:n},type:"POST",success:function(){$("#CommentText").val("");getComments()},error:function(){alert("Something happened")}})})});$("#CommentListSegment").on("click",".SwitchPageBtn",getComments);(function(){var w,b,k,a,nt,h,v,f,c,r,t,o,y,d,g,p,e,l,n=window.$game={_mode:null,busy:!1},u,i,s;n.new=function(){this.mode("map")};n.reset=function(){this.mode("welcome")};n.save=function(){return{mode:this._mode,map:this.map.save(),dialog:this.dialog.save()}};n.load=function(n){this.mode(n.mode);this.map.load(n.map);this.dialog.load(n.dialog)};n.mode=function(n,t){if(!this.busy){switch(n){case"dialog":this.map.show(!1);this.quest.show(null);this._showWelcome(!1);this.dialog.goto(null,t);break;case"map":this.dialog.show(!1);this.quest.show(null);this._showWelcome(!1);this.map.show(!0);break;case"welcome":this.map.show(!1);this.dialog.show(!1);this.quest.show(null);this._showWelcome(!0);break;case"quest":this.map.show(!1);this.dialog.show(!1);this._showWelcome(!1);this.quest.show(t);break;default:console.error("Invalid mode '"+n+"'")}this._mode=n}};n._showWelcome=function(n){b.css("display",n?"":"none")};u=n.map={_areas:{}};u.save=function(){return{}};u.load=function(){};u.addArea=function(n,t,i,r){var u=this._areas[n]={name:n,pos:t.slice(),title:i,menu:r.slice()}};u.show=function(t){var f,u,i,r;if(!n.busy){if(t&&!this._init){this._init=!0;f=$("#map-area-tpl").html();for(u in this._areas)this._areas.hasOwnProperty(u)&&(i=this._areas[u],r=i.elem=$(f),r.appendTo(a),r.css("left",i.pos[0]+"%"),r.css("top",i.pos[1]+"%"),r.css("width",i.pos[2]+"%"),r.css("height",i.pos[3]+"%"),r.click(this._showChapterMenu.bind(this,i)))}a.css("display",t?"":"none")}};u._showChapterMenu=function(n){var o=$("#map-chapter-menu-tpl").html(),f,i,t,r,u,e;for(v.html(null),f=$(".ch-title",h),f.html(n.title),i=0;i<n.menu.length;i++)t=n.menu[i],r=$(o),r.appendTo(v),u=$(".cc-img",r),e=$(".cc-text",r),e.html(t.name),t.icon&&u.attr("src",t.icon),u.click(this._selectChapter.bind(this,t));h.modal("show")};u._selectChapter=function(t){h.modal("hide");t.dialog&&n.mode("dialog",t.dialog)};i=n.dialog={_stages:{},_actions:{},_index:0,_stage:null};i.save=function(){return{index:this._index,stage:this._stage.name,image:t.attr("src"),scene:$U.getBgImage(o),text:c.html(),name:r.html()}};i.load=function(n){this._index=n.index;this._stage=this._stages[n.stage];n.image?(t.attr("src",n.image),t.removeClass("dg-hidden")):t.addClass("dg-hidden");$U.setBgImage(o,n.scene);c.html(n.text);n.name?(r.html(n.name),r.css("display","")):r.css("display","none")};i.setStage=function(n,t){for(var r={},i=0;i<t.length;i++)t[i].id&&(r[t[i].id]=i);this._stages[n]={name:n,data:t.slice(),labels:r}};i.setAction=function(n,t){this._actions[n]=t};i.advance=function(){var i,s,e,u,h;if(this._stage&&!n.busy){n:while(i=this._stage.data[this._index]){this._index++;switch(i.do){case"say":c.html(i.text);i.name?(r.css("display",""),r.html(i.name)):r.css("display","none");break n;case"image":if(s=t.attr("src"),e=i.url||f,i.now&&s!=f&&e!=f){t.attr("src",e);break}else{u=$U.always({self:this,url:e});s!=f&&(u=u.then(function(n){return t.addClass("dg-hidden"),$U.delay(500,n)}));e!=f&&(u=u.then(function(n){return t.attr("src",n.url),t.removeClass("dg-hidden"),$U.delay(500,n)}));u.then(function(t){n.busy=!1;t.self.advance()});n.busy=!0;break n}case"scene":u=$U.always({url:i.url,text:i.text,self:this});u=u.then(function(n){return d.html(n.text||null),y.addClass("dg-faded"),$U.delay(500,n)});i.text&&(u=u.then(function(n){return $U.delay(1e3,n)}));u.then(function(n){return y.removeClass("dg-faded"),$U.setBgImage(o,n.url),$U.delay(500,n)}).then(function(t){n.busy=!1;t.self.advance()});n.busy=!0;break n;case"goto":this._goto(i.label,i.stage);break;case"action":(h=this._actions[i.name])?h.apply(n,i.args):i.name&&console.error("Invalid action '"+i.name+"'")}}p.css("display",i?"":"none")}};i._goto=function(n,t){var i,r;if(t){if(i=this._stages[t],!i){console.error("Invalid stage '"+t+"'");return}this._stage=i}if(n){if(r=this._stage.labels[n],!r){console.error("Invalid label '"+n+"'");return}this._index=r}else this._index=0};i.goto=function(t,i){n.busy||(this._goto(t,i),this.advance())};i.show=function(t){this._stage&&!n.busy&&(g.css("display",t?"":"none"),o.css("display",t?"":"none"))};i.setAction("show",function(){this.dialog.show(!0)});i.setAction("hide",function(){this.dialog.show(!1)});i.setAction("ChapterDone",function(){this.mode("map")});s=n.quest={_isload:!1};s.save=function(){return{}};s.load=function(){};s.show=function(t){t?(n.busy=!0,this._isload=!0,e.attr("src",t),l.css("display","")):(e.attr("src","about:blank"),e.css("display","none"),l.css("display","none"))};s._onLoad=function(){this._isload&&(n.busy=!1,this._isload=!1,e.css("display",""),l.css("display","none"))};$(document).ready(function(){w=$("a.newgame-btn");b=$(".game-welcome");k=$(".game-welcome .play-btn");c=$(".dg-text span.text");r=$(".dg-text span.name");t=$(".dg-image img");o=$(".dialog-scene");y=$(".dialog-fade");d=$(".dialog-fade .fade-text");g=$(".dialog-box");p=$(".dialog-box a.next-btn");f=t.attr("src");t.addClass("dg-hidden");a=$(".map-body");nt=$(".map-body img.map-bg");h=$("#map-chapter-menu");v=$("#map-chapter-menu .ch-list");e=$("iframe.quest-embed");l=$(".quest-loading");p.click(function(){n.dialog.advance()});e.on("load",function(){n.quest._onLoad()});k.click(function(){n.new()});w.click(function(){confirm("Действительно начать игру заново?")&&n.reset()})})}).call(this),function(){var n=window.$U={};n.getBgImage=function(n){var i=$(n).css("background-image"),t=i.match(/url\("(.+)"\)/i);return t&&t[1]?t[1]:null};n.setBgImage=function(n,t){t?(t='url("'+t.replace('"',"%22")+'")',$(n).css("background-image",t)):$(n).css("background-image","none")};n.delay=function(n,t){return $.Deferred(function(i){setTimeout(i.resolve.bind(null,t),n)})};n.always=function(n){return $.Deferred(function(t){t.resolve.call(null,n)})}}.call(this);$(document).ready(function(){$("div.has-bg img.is-bg").each(function(){var n=$(this);$U.setBgImage(n.parent(),n.attr("src"));n.remove()});$(".system-menu > a").each(function(){$(this).attr("href","javascript:void(0)")});var n=$("a.fullscreen-btn");n.click(function(){if(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen();else{var t=$(this).attr("data-target"),n=document.getElementById(t);n.requestFullscreen?n.requestFullscreen():n.mozRequestFullScreen?n.mozRequestFullScreen():n.webkitRequestFullscreen?n.webkitRequestFullscreen():n.msRequestFullscreen&&n.msRequestFullscreen()}})});