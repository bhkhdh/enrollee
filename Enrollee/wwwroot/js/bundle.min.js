var getComments=function(){var n=$(this).attr("data-page");$.ajax({url:"/Comments/GetComments",type:"GET",data:{page:n},success:function(n){$("#CommentListSegment").html(n)},error:function(){alert("Something happened!")}})};$(document).ready(function(){$("#SubmitComment").click(function(){var n=$("#CommentText").val();$.ajax({url:"/Comments/CreateFromPartial",data:{data:n},type:"POST",success:function(){$("#CommentText").val("");getComments()},error:function(){alert("Something happened")}})})});$("#CommentListSegment").on("click",".SwitchPageBtn",getComments);(function(){var b,k,d,g,v,it,c,y,e,u,r,i,h,l,p,nt,tt,w,o,a,n=window.$game={_mode:null,busy:!1},f,t,s;n.new=function(){this.mode("map")};n.reset=function(){this.mode("welcome")};n.save=function(){return{mode:this._mode,map:this.map.save(),dialog:this.dialog.save(),quest:this.quest.save()}};n.load=function(n){n&&(this.mode(n.mode),this.map.load(n.map),this.dialog.load(n.dialog),this.quest.load(n.quest),this.mode(n.mode))};n.serverSave=function(n){var t=n?"":JSON.stringify(this.save());$("#game-save-data").text(t);$.ajax({method:"post",url:"/Manage/UpdateSaveData",data:{data:t}})};n.serverLoad=function(){var n=$("#game-save-data").text();n.length>0&&(console.log("load now"),this.load(JSON.parse(n)))};n.mode=function(n,t){if(!this.busy){switch(n){case"dialog":this.map.show(!1);this.quest.begin(null);this._showWelcome(!1);t!==undefined?this.dialog.goto(null,t):this.dialog.show(!0);break;case"map":this.dialog.show(!1);this.quest.begin(null);this._showWelcome(!1);this.map.show(!0);break;case"welcome":this.map.show(!1);this.dialog.show(!1);this.quest.begin(null);this._showWelcome(!0);break;case"quest":this.map.show(!1);this.dialog.show(!1);this._showWelcome(!1);t!==undefined?this.quest.begin(t):this.quest.show(!0);break;default:console.error("Invalid mode '"+n+"'")}this._mode=n}};n._showWelcome=function(n){d.css("display",n?"":"none")};f=n.map={_areas:{},_blocked:{}};f.save=function(){return{blocked:$.extend({},this._blocked)}};f.load=function(n){this._blocked=$.extend({},n.blocked);for(var t in this._areas)this._areas.hasOwnProperty(t)&&this.setBlocked(t,this._blocked[t])};f.addArea=function(n,t,i,r){var u=this._areas[n]={name:n,pos:t.slice(),title:i,menu:r.slice()};this._blocked[n]=!0};f.show=function(t){var f,u,i,r;if(!n.busy){if(t&&!this._init){this._init=!0;f=$("#map-area-tpl").html();for(u in this._areas)this._areas.hasOwnProperty(u)&&(i=this._areas[u],r=i.elem=$(f),r.appendTo(v),this._blocked[i.name]&&r.addClass("blocked"),r.css("left",i.pos[0]+"%"),r.css("top",i.pos[1]+"%"),r.css("width",i.pos[2]+"%"),r.css("height",i.pos[3]+"%"),r.click(this._showChapterMenu.bind(this,i)))}v.css("display",t?"":"none")}};f.setBlocked=function(n,t){var i=this._areas[n];if(!i){console.error("Invalid map area '"+n+"'");return}this._blocked[n]=!!t;i.elem&&i.elem.toggleClass("blocked",t)};f._showChapterMenu=function(n){var f,e,i,t,r,u,o;if(!this._blocked[n.name]){for(f=$("#map-chapter-menu-tpl").html(),y.html(null),e=$(".ch-title",c),e.html(n.title),i=0;i<n.menu.length;i++)t=n.menu[i],r=$(f),r.appendTo(y),u=$(".cc-img",r),o=$(".cc-text",r),o.html(t.name),t.icon&&u.attr("src",t.icon),u.click(this._selectChapter.bind(this,t));c.modal("show")}};f._selectChapter=function(t){c.modal("hide");t.dialog&&n.mode("dialog",t.dialog)};t=n.dialog={_stages:{},_actions:{},_index:0,_stage:null};t.save=function(){return{index:this._index,stage:this._stage?this._stage.name:null,image:i.attr("src"),scene:$U.getBgImage(h),overlay:$U.getBgImage(l),text:u.html(),name:r.html()}};t.load=function(n){this._index=n.index;this._stage=this._stages[n.stage];n.image?(i.attr("src",n.image),i.removeClass("dg-hidden"),u.removeClass("dg-hidden")):(i.addClass("dg-hidden"),u.addClass("dg-hidden"));$U.setBgImage(h,n.scene);$U.setBgImage(l,n.overlay);u.html(n.text);n.name?(r.html(n.name),r.css("display","")):r.css("display","none")};t.setStage=function(n,t){for(var r={},i=0;i<t.length;i++)t[i].id&&(r[t[i].id]=i);this._stages[n]={name:n,data:t.slice(),labels:r}};t.setAction=function(n,t){this._actions[n]=t};t.advance=function(){var t,s,o,f,c;if(this._stage&&!n.busy){n:while(t=this._stage.data[this._index]){this._index++;switch(t.do){case"say":u.html(t.text);t.name?(r.css("display",""),r.html(t.name)):(r.css("display","none"),r.html(null));break n;case"image":if(s=i.attr("src"),o=t.url||e,t.now&&s!=e&&o!=e){i.attr("src",o);break}else{f=$U.always({url:o});n.busy=!0;s!=e&&(f=f.then(function(n){return u.addClass("dg-hidden"),i.addClass("dg-hidden"),$U.delay(500,n)}));f=o!=e?f.then(function(n){return i.attr("src",n.url),u.removeClass("dg-hidden"),i.removeClass("dg-hidden"),$U.delay(500,n)}):f.then(function(n){return i.attr("src",e),$U.always(n)});f.then(function(){n.busy=!1;n.dialog.advance()});break n}case"scene":f=$U.always({url:t.url,text:t.text});n.busy=!0;f=f.then(function(n){return nt.html(n.text||null),p.addClass("dg-faded"),$U.delay(500,n)});t.text&&(f=f.then(function(n){return $U.delay(1e3,n)}));f.then(function(n){return p.removeClass("dg-faded"),$U.setBgImage(h,n.url),$U.delay(500,n)}).then(function(){n.busy=!1;n.dialog.advance()});break n;case"goto":this._goto(t.label,t.stage);break;case"action":if(c=this._actions[t.name]){if(c.apply(n,t.args))break n}else t.name&&console.error("Invalid action '"+t.name+"'")}}w.css("display",t?"":"none")}};t._goto=function(n,t){var i,r;if(t){if(i=this._stages[t],!i){console.error("Invalid stage '"+t+"'");return}this._stage=i}if(n){if(r=this._stage.labels[n],!r){console.error("Invalid label '"+n+"'");return}this._index=r}else this._index=0};t.goto=function(t,i){n.busy||(this._goto(t,i),this.advance())};t.show=function(t){this._stage&&!n.busy&&(tt.css("display",t?"":"none"),h.css("display",t?"":"none"))};t.overlay=function(n){$U.setBgImage(l,n||null)};t.setAction("show",function(){this.dialog.show(!0)});t.setAction("hide",function(){this.dialog.show(!1)});t.setAction("Overlay",function(n){this.dialog.overlay(n)});t.setAction("ChapterDone",function(n,t){t&&this.map.setBlocked(t,!1);this.mode("map")});t.setAction("StartQuest",function(n){return this.mode("quest",n),!0});s=n.quest={_isload:!1,_url:null};s.save=function(){return{url:this._url}};s.load=function(n){this.begin(n.url)};s.begin=function(t){n.busy||(t?(n.busy=!0,this._isload=!0,this._url=t,o.attr("src",t),a.css("display","")):(this._url=null,o.attr("src","about:blank"),o.css("display","none"),a.css("display","none")))};s.show=function(t){this._url&&!n.busy&&o.css("display",t?"":"none")};s._onLoad=function(){this._isload&&(n.busy=!1,this._isload=!1,o.css("display",""),a.css("display","none"))};s._onMessage=function(t){switch(t){case"quest-ok":n.mode("dialog");n.dialog.advance()}};$(document).ready(function(){b=$("a.newgame-btn");k=$("a.savegame-btn");d=$(".game-welcome");g=$(".game-welcome .play-btn");u=$(".dg-text span.text");r=$(".dg-text span.name");i=$(".dg-image img");h=$(".dialog-scene");l=$(".dialog-overlay");p=$(".dialog-fade");nt=$(".dialog-fade .fade-text");tt=$(".dialog-box");w=$(".dialog-box a.next-btn");e=i.attr("src");i.addClass("dg-hidden");v=$(".map-body");it=$(".map-body img.map-bg");c=$("#map-chapter-menu");y=$("#map-chapter-menu .ch-list");o=$("iframe.quest-embed");a=$(".quest-loading");w.click(function(){n.dialog.advance()});o.on("load",function(){n.quest._onLoad()});$(window).on("message",function(t){var i=t.originalEvent.data;n.quest._onMessage(i)});g.click(function(){var t=$("#game-save-data").text();t.length>0&&confirm("Загрузить ранее сохранённый прогресс?")?n.serverLoad():(n.new(),n.serverSave(!0))});b.click(function(){confirm("Действительно начать игру заново?")&&(n.reset(),n.serverSave(!0))});k.click(function(){n.serverSave(!1);alert("Ваш игровой прогресс сохранён!")})})}).call(this),function(){var n=window.$U={};n.getBgImage=function(n){var i=$(n).css("background-image"),t=i.match(/url\("(.+)"\)/i);return t&&t[1]?t[1]:null};n.setBgImage=function(n,t){t?(t='url("'+t.replace('"',"%22")+'")',$(n).css("background-image",t)):$(n).css("background-image","none")};n.delay=function(n,t){return $.Deferred(function(i){setTimeout(i.resolve.bind(null,t),n)})};n.always=function(n){return $.Deferred(function(t){t.resolve.call(null,n)})}}.call(this);$(document).ready(function(){$("div.has-bg img.is-bg").each(function(){var n=$(this);$U.setBgImage(n.parent(),n.attr("src"));n.remove()});$(".system-menu > a").each(function(){$(this).attr("href","javascript:void(0)")});var n=$("a.fullscreen-btn");n.click(function(){if(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen();else{var t=$(this).attr("data-target"),n=document.getElementById(t);n.requestFullscreen?n.requestFullscreen():n.mozRequestFullScreen?n.mozRequestFullScreen():n.webkitRequestFullscreen?n.webkitRequestFullscreen():n.msRequestFullscreen&&n.msRequestFullscreen()}})});